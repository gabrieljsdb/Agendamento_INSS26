<?php
// FINAL COM TEMPLATE COOLADMIN: Dashboard do Administrador
session_start();
require '../conexao.php'; // Caminho correto para a conexão

if (!isset($_SESSION['admin_logado']) || $_SESSION['admin_logado'] !== true) {
    header('Location: login.php');
    exit;
}

// Lógica de filtros
$data_inicio = $_GET['data_inicio'] ?? '';
$data_fim = $_GET['data_fim'] ?? '';
$status_filtro = $_GET['status'] ?? 'Todos';

$sql = "SELECT a.id, a.data_agendamento, a.hora_inicio, a.status, a.motivo, a.observacao, a.motivo_cancelamento, u.nome, u.email, u.oab, u.cpf_oab FROM agendamentos a JOIN usuarios u ON a.id_usuario = u.id";
$where_clauses = [];
$params = [];
if ($data_inicio && $data_fim) { $where_clauses[] = "a.data_agendamento BETWEEN ? AND ?"; $params[] = $data_inicio; $params[] = $data_fim; }
if ($status_filtro && $status_filtro !== 'Todos') { $where_clauses[] = "a.status = ?"; $params[] = $status_filtro; }
if (!empty($where_clauses)) { $sql .= " WHERE " . implode(" AND ", $where_clauses); }
$sql .= " ORDER BY a.data_agendamento DESC, a.hora_inicio DESC";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$todos_agendamentos = $stmt->fetchAll(PDO::FETCH_ASSOC);
?>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard do Administrador</title>
    
    <!-- Lembre-se que os caminhos usam ../ para voltar uma pasta -->
    <link href="../css/font-face.css" rel="stylesheet" media="all">
    <link href="../vendor/font-awesome-5/css/fontawesome-all.min.css" rel="stylesheet" media="all">
    <link href="../vendor/mdi-font/css/material-design-iconic-font.min.css" rel="stylesheet" media="all">
    <link href="../vendor/bootstrap-4.1/bootstrap.min.css" rel="stylesheet" media="all">
    <link href="../vendor/animsition/animsition.min.css" rel="stylesheet" media="all">
    <link href="../css/theme.css" rel="stylesheet" media="all">
</head>

<body class="animsition">
    <div class="page-wrapper">
        <!-- MENU LATERAL -->
        <aside class="menu-sidebar d-none d-lg-block">
            <div class="logo">
                <a href="dashboard.php">
                    <img src="../images/icon/logo.png" alt="CoolAdmin" />
                </a>
            </div>
            <div class="menu-sidebar__content js-scrollbar1">
                <nav class="navbar-sidebar">
                    <ul class="list-unstyled navbar__list">
                        <li class="active">
                            <a href="dashboard.php"><i class="fas fa-tachometer-alt"></i>Dashboard</a>
                        </li>
                        <li>
                            <a href="bloqueios.php"><i class="fas fa-ban"></i>Gerenciar Bloqueios</a>
                        </li>
                        <li>
                            <a href="gerenciar_admins.php"><i class="fas fa-users-cog"></i>Gerenciar Admins</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>
        <!-- FIM DO MENU LATERAL -->

        <!-- CONTAINER DA PÁGINA -->
        <div class="page-container">
            <!-- HEADER -->
            <header class="header-desktop">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                        <div class="header-wrap">
                            <form class="form-header" action="" method="POST"></form>
                            <div class="header-button">
                                <div class="account-wrap">
                                    <div class="account-item clearfix js-item-menu">
                                        <div class="content">
                                            <a class="js-acc-btn" href="#"><?php echo htmlspecialchars($_SESSION['admin_usuario']); ?></a>
                                        </div>
                                        <div class="account-dropdown js-dropdown">
                                            <div class="account-dropdown__footer">
                                                <a href="logout.php"><i class="zmdi zmdi-power"></i>Sair</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <!-- FIM DO HEADER -->

            <!-- CONTEÚDO PRINCIPAL -->
            <div class="main-content">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-12">
                                <h3 class="title-5 m-b-35">Monitoramento de Agendamentos</h3>
                                <!-- FERRAMENTAS DA TABELA (FILTROS) -->
                                <div class="table-data__tool">
                                    <div class="table-data__tool-left">
                                        <form method="GET" action="dashboard.php" class="form-inline">
                                            <div class="form-group mx-sm-3">
                                                <label for="data_inicio" class="mr-2">De:</label>
                                                <input type="date" class="form-control" name="data_inicio" value="<?php echo htmlspecialchars($data_inicio); ?>">
                                            </div>
                                            <div class="form-group mx-sm-3">
                                                <label for="data_fim" class="mr-2">Até:</label>
                                                <input type="date" class="form-control" name="data_fim" value="<?php echo htmlspecialchars($data_fim); ?>">
                                            </div>
                                            <div class="form-group mx-sm-3">
                                                <label for="status" class="mr-2">Status:</label>
                                                <select name="status" class="form-control">
                                                    <option value="Todos" <?php if ($status_filtro === 'Todos') echo 'selected'; ?>>Todos</option>
                                                    <option value="Confirmado" <?php if ($status_filtro === 'Confirmado') echo 'selected'; ?>>Confirmado</option>
                                                    <option value="Cancelado" <?php if ($status_filtro === 'Cancelado') echo 'selected'; ?>>Cancelado</option>
                                                </select>
                                            </div>
                                            <button class="au-btn-filter" type="submit"><i class="zmdi zmdi-filter-list"></i> Filtrar</button>
                                        </form>
                                    </div>
                                    <div class="table-data__tool-right">
                                        <button class="au-btn au-btn-icon au-btn--blue au-btn--small" type="submit" form="form-export">
                                            <i class="zmdi zmdi-download"></i>Exportar CSV
                                        </button>
                                    </div>
                                    <form id="form-export" method="GET" action="exportar.php" target="_blank" style="display:none;">
                                        <input type="hidden" name="data_inicio" value="<?php echo htmlspecialchars($data_inicio); ?>">
                                        <input type="hidden" name="data_fim" value="<?php echo htmlspecialchars($data_fim); ?>">
                                        <input type="hidden" name="status" value="<?php echo htmlspecialchars($status_filtro); ?>">
                                    </form>
                                </div>
                                <!-- TABELA DE DADOS -->
                                <div class="table-responsive table-responsive-data2">
                                    <table class="table table-data2">
                                        <thead>
                                            <tr><th>Data/Hora</th><th>Nome</th><th>CPF</th><th>OAB</th><th>Email</th><th>Motivo</th><th>Status</th><th></th></tr>
                                        </thead>
                                        <tbody>
                                            <?php foreach ($todos_agendamentos as $ag): ?>
                                            <tr class="tr-shadow">
                                                <td><?php echo date('d/m/Y H:i', strtotime($ag['data_agendamento'] . ' ' . $ag['hora_inicio'])); ?></td>
                                                <td><?php echo htmlspecialchars($ag['nome']); ?></td>
                                                <td><?php echo htmlspecialchars($ag['cpf_oab']); ?></td>
                                                <td><?php echo htmlspecialchars($ag['oab']); ?></td>
                                                <td><span class="block-email"><?php echo htmlspecialchars($ag['email']); ?></span></td>
                                                <td class="desc"><?php echo htmlspecialchars($ag['motivo']); ?></td>
                                                <td>
                                                    <?php $statusClass = $ag['status'] === 'Confirmado' ? 'status--process' : 'status--denied'; ?>
                                                    <span class="<?php echo $statusClass; ?>"><?php echo $ag['status']; ?></span>
                                                </td>
                                                <td>
                                                    <!-- Espaço para futuras ações, como ver detalhes -->
                                                </td>
                                            </tr>
                                            <tr class="spacer"></tr>
                                            <?php endforeach; ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- FIM DO CONTEÚDO PRINCIPAL -->
        </div>
        <!-- FIM DO CONTAINER DA PÁGINA -->
    </div>

    <!-- Scripts JS -->
    <script src="../vendor/jquery-3.2.1.min.js"></script>
    <script src="../vendor/bootstrap-4.1/popper.min.js"></script>
    <script src="../vendor/bootstrap-4.1/bootstrap.min.js"></script>
    <script src="../vendor/animsition/animsition.min.js"></script>
    <script src="../js/main.js"></script>
</body>
</html>