<?php
// admin/admin_buscar_agendamentos.php --- VERSÃO FINAL E CORRETA

session_start();
$session_id = session_id(); // <-- ADICIONE ESTA LINHA
require '../conexao.php';

// Proteção: Apenas administradores logados podem acessar estes dados.
// Se esta linha estiver causando problemas, é um problema de SESSÃO,
// mas a solução não é removê-la, e sim corrigir o problema da sessão.
if (!isset($_SESSION['admin_logado']) || $_SESSION['admin_logado'] !== true) {
    echo json_encode([]); // Retorna um array vazio se não estiver logado
    exit;
}

$eventos = [];

// 1. Busca todos os agendamentos com os dados do usuário associado
$query_agendamentos = "SELECT a.id, a.data_agendamento, a.hora_inicio, a.hora_fim, a.status, a.motivo, a.observacao, u.nome, u.email, u.oab, u.cpf_oab
                       FROM agendamentos a 
                       JOIN usuarios u ON a.id_usuario = u.id";

try {
    $stmt_agendamentos = $pdo->query($query_agendamentos);

    while ($row = $stmt_agendamentos->fetch(PDO::FETCH_ASSOC)) {
        // Define a cor baseada no status do agendamento
        $cor = '#28a745'; // Verde para Confirmado (padrão)
        if ($row['status'] === 'Cancelado') {
            $cor = '#ff0000ff'; // Cinza para Cancelado
        }

        // Monta o array de evento no formato que o FullCalendar entende
        $eventos[] = [
            'id'    => $row['id'],
            'title' => $row['nome'],
            'start' => $row['data_agendamento'] . 'T' . $row['hora_inicio'],
            'end'   => $row['data_agendamento'] . 'T' . $row['hora_fim'],
            'backgroundColor' => $cor,
            'borderColor' => $cor,
            'extendedProps' => [
                'id' => $row['id'],
                'nome' => $row['nome'],
                'status' => $row['status'],
                'motivo' => $row['motivo'],
                'observacao' => $row['observacao'],
                'email' => $row['email'],
                'oab' => $row['oab'],
                'cpf' => $row['cpf_oab']
            ]
        ];
    }

    // 2. Busca os bloqueios (código que você já tinha)
    $query_bloqueios = "SELECT data_bloqueio, data_fim_bloqueio, hora_inicio_bloqueio, hora_fim_bloqueio, motivo_bloqueio FROM bloqueios";
    $stmt_bloqueios = $pdo->query($query_bloqueios);
    while ($row = $stmt_bloqueios->fetch(PDO::FETCH_ASSOC)) {
        $data_inicio = new DateTime($row['data_bloqueio']);
        $data_fim = $row['data_fim_bloqueio'] ? new DateTime($row['data_fim_bloqueio']) : clone $data_inicio;
        
        for ($data = $data_inicio; $data <= $data_fim; $data->modify('+1 day')) {
            if ($row['hora_inicio_bloqueio']) {
                $eventos[] = [ 'title' => $row['motivo_bloqueio'] ?: 'Bloqueado', 'start' => $data->format('Y-m-d') . 'T' . $row['hora_inicio_bloqueio'], 'end' => $data->format('Y-m-d') . 'T' . $row['hora_fim_bloqueio'], 'backgroundColor' => '#007bff', 'borderColor' => '#007bff' ];
            } else {
                 $eventos[] = [ 'title' => $row['motivo_bloqueio'] ?: 'Dia Bloqueado', 'start' => $data->format('Y-m-d'), 'allDay' => true, 'display' => 'background', 'backgroundColor' => '#ffc107' ];
            }
        }
    }

} catch (PDOException $e) {
    // Em caso de erro na consulta, retorna um JSON de erro para o calendário
    // E loga o erro no servidor para depuração.
    http_response_code(500);
    error_log("Erro na consulta de agendamentos do admin: " . $e->getMessage());
    echo json_encode(['error' => 'Erro ao buscar dados do banco.']);
    exit;
}

// Imprime o array de eventos formatado como JSON
echo json_encode($eventos);